# Docker Compose for testing horizontal scaling with multiple WS Gateway instances
# Usage: docker-compose -f docker-compose.multi-gateway.yml up

services:
  # Redis (shared by all gateway instances)
  redis:
    image: redis:7-alpine
    container_name: chat_redis_multi
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # WebSocket Gateway Instance 1
  ws-gateway-1:
    build:
      context: .
      dockerfile: Dockerfile.ws-gateway
    container_name: ws_gateway_1
    environment:
      - REDIS_ADDR=redis:6379
      - WS_GATEWAY_ADDR=:8080
      - WS_GATEWAY_INSTANCE_ID=gateway-1
    ports:
      - "8081:8080"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # WebSocket Gateway Instance 2
  ws-gateway-2:
    build:
      context: .
      dockerfile: Dockerfile.ws-gateway
    container_name: ws_gateway_2
    environment:
      - REDIS_ADDR=redis:6379
      - WS_GATEWAY_ADDR=:8080
      - WS_GATEWAY_INSTANCE_ID=gateway-2
    ports:
      - "8082:8080"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Optional: Third gateway instance for more thorough testing
  ws-gateway-3:
    build:
      context: .
      dockerfile: Dockerfile.ws-gateway
    container_name: ws_gateway_3
    environment:
      - REDIS_ADDR=redis:6379
      - WS_GATEWAY_ADDR=:8080
      - WS_GATEWAY_INSTANCE_ID=gateway-3
    ports:
      - "8083:8080"
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - three-gateways
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
