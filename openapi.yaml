openapi: 3.0.3
info:
  title: Social Media Post & Interaction API
  description: |
    API dành cho dịch vụ Bài viết (Post), Bình luận (Comment) và Tương tác (Reaction)
    Phiên bản không yêu cầu xác thực JWT, chỉ truyền header X-User-ID (UUID) cho các thao tác ghi.
  version: 1.0.0
servers:
  - url: http://localhost:8000/api/v1
    description: Local Development Server

paths:
  ## POST PATHS
  /posts:
    get:
      tags: [Posts]
      summary: Lấy danh sách bài viết (Truy vấn tổng hợp)
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - $ref: '#/components/parameters/Cursor'
        - name: q
          in: query
          schema: { type: string }
          description: Từ khóa tìm kiếm trong nội dung bài viết.
        - name: user_id
          in: query
          schema: { type: string }
          description: Lọc theo ID người dùng đăng bài.
        - name: status
          in: query
          schema: { type: boolean }
          description: Lọc theo trạng thái kích hoạt.
        - name: tag
          in: query
          schema: { type: array, items: { type: string } }
          description: Lọc theo hashtag (tồn tại trong tags array).
        - $ref: '#/components/parameters/SortBy'
        - $ref: '#/components/parameters/Order'
      responses:
        '200':
          description: Danh sách bài viết được truy vấn thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
    post:
      tags: [Posts]
      summary: Tạo bài viết mới (multipart)
      description: |\n        Tạo bài viết mới với nội dung và danh sách file media (ảnh/video).\n        Trường `tags` gửi dạng JSON array trong multipart form.\n      parameters:
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: false
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/PostCreate'
      responses:
        '201':
          description: Bài viết được tạo thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostSingleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /posts/{post_id}:
    get:
      tags: [Posts]
      summary: Xem chi tiết một bài viết cụ thể
      parameters:
        - $ref: '#/components/parameters/PostId'
      responses:
        '200':
          description: Lấy chi tiết bài viết thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostSingleResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags: [Posts]
      summary: Chỉnh sửa một phần bài viết (multipart)
      description: |\n        Khi PATCH luôn xóa toàn bộ media cũ trước, sau đó nếu có files mới sẽ upload.\n        Nếu không gửi files => media_urls sẽ bị xóa (set null).\n      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: false
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/PostUpdate'
      responses:
        '200':
          description: Cập nhật bài viết thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PostSingleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
    delete:
      tags: [Posts]
      summary: Xóa bài viết
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/XUserId'
      responses:
        '204':
          description: Xóa bài viết thành công (No Content).
        '403':
          $ref: '#/components/responses/Forbidden'
        - $ref: '#/components/parameters/PostId'
      responses:
        '204':
          description: Xóa bài viết thành công (No Content).
        '403':
          $ref: '#/components/responses/Forbidden'

  ## REACTION PATHS (Cho Bài viết)
  /posts/{post_id}/reactions:
    get:
      tags: [Reactions]
      summary: Lấy danh sách Reactions của bài viết
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - $ref: '#/components/parameters/Cursor'
        - name: reaction_type
          in: query
          schema: { type: string, enum: [like, love, haha, wow, sad, angry] }
          description: Lọc theo loại Reaction.
      responses:
        '200':
          description: Danh sách Reactions được trả về thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReactionListResponse'
    post:
      tags: [Reactions]
      summary: Thêm hoặc Cập nhật Reaction bài viết (UPSERT)
      description: Tạo mới hoặc cập nhật reaction_type cho bài viết. Nếu đã tồn tại sẽ update thay vì tăng reacts_count.
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReactionUpsert'
      responses:
        '200':
          description: Reaction được tạo/cập nhật thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReactionSingleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Reactions]
      summary: Bỏ Reaction bài viết
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/XUserId'
      responses:
        '204':
          description: Bỏ Reaction thành công.
        '404':
          $ref: '#/components/responses/NotFound'

  ## COMMENT PATHS
  /posts/{post_id}/comments:
    get:
      tags: [Comments]
      summary: Lấy danh sách Comments của bài viết
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - $ref: '#/components/parameters/Cursor'
        - name: user_id
          in: query
          schema: { type: string }
          description: Lọc Comments theo user_id.
      responses:
        '200':
          description: Danh sách Comments được trả về thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentListResponse'
    post:
      tags: [Comments]
      summary: Tạo Comment mới (multipart)
      description: Tạo comment với nội dung text và/hoặc media files. Nếu có parent_id thì là reply.
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: false
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CommentCreate'
      responses:
        '201':
          description: Comment được tạo thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentSingleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /posts/{post_id}/comments/{comment_id}:
    get:
      tags: [Comments]
      summary: Lấy chi tiết một Comment
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/CommentId'
      responses:
        '200':
          description: Chi tiết Comment được trả về thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentSingleResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags: [Comments]
      summary: Chỉnh sửa Comment (multipart)
      description: Xóa toàn bộ media cũ trước khi upload media mới. Không gửi files sẽ xóa media.
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/CommentId'
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: false
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CommentUpdate'
      responses:
        '200':
          description: Cập nhật Comment thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentSingleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Comments]
      summary: Xóa Comment
      parameters:
        - $ref: '#/components/parameters/PostId'
        - $ref: '#/components/parameters/CommentId'
        - $ref: '#/components/parameters/XUserId'
      responses:
        '204':
          description: Xóa Comment thành công.
        '404':
          $ref: '#/components/responses/NotFound'

  ## REACTION PATHS (Cho Comment)
  /comments/{comment_id}/reactions:
    get:
      tags: [Reactions]
      summary: Lấy danh sách Reactions của Comment
      parameters:
        - $ref: '#/components/parameters/CommentId'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - name: reaction_type
          in: query
          schema: { type: string, enum: [like, love, haha, wow, sad, angry] }
          description: Lọc theo loại Reaction.
      responses:
        '200':
          description: Danh sách Reactions được trả về thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReactionListResponse'
    post:
      tags: [Reactions]
      summary: Thêm hoặc Cập nhật Reaction Comment (UPSERT)
      description: Tạo mới hoặc cập nhật reaction_type cho comment. Nếu đã tồn tại sẽ update thay vì tăng reacts_count.
      parameters:
        - $ref: '#/components/parameters/CommentId'
        - $ref: '#/components/parameters/XUserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReactionUpsert'
      responses:
        '200':
          description: Reaction được tạo/cập nhật thành công.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReactionSingleResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Reactions]
      summary: Bỏ Reaction Comment
      parameters:
        - $ref: '#/components/parameters/CommentId'
        - $ref: '#/components/parameters/XUserId'
      responses:
        '204':
          description: Bỏ Reaction thành công.
        '404':
          $ref: '#/components/responses/NotFound'
          
components:
  # PARAMETERS
  parameters:
    PostId:
      name: post_id
      in: path
      required: true
      schema: { type: string }
      description: ID của bài viết.
    CommentId:
      name: comment_id
      in: path
      required: true
      schema: { type: string }
      description: ID của Comment.
    Limit:
      name: limit
      in: query
      schema: { type: integer, default: 20 }
      description: Số lượng bản ghi tối đa.
    Offset:
      name: offset
      in: query
      schema: { type: integer, default: 0 }
      description: Vị trí bắt đầu (bỏ qua X bản ghi).
    Cursor:
      name: cursor
      in: query
      schema: { type: string }
      description: ID của bản ghi cuối cùng đã lấy (cursor-based pagination).
    SortBy:
      name: sort_by
      in: query
      schema: { type: string, default: created_at }
      description: Trường sắp xếp.
    Order:
      name: order
      in: query
      schema: { type: string, enum: [asc, desc], default: desc }
      description: Chiều sắp xếp.
    XUserId:
      name: X-User-ID
      in: header
      required: true
      schema: { type: string, description: UUID của người dùng thực hiện thao tác ghi. }
      description: Header bắt buộc cho thao tác tạo/sửa/xóa.


  # PARAMETERS
  parameters:
    PostId:
      name: post_id
      in: path
      required: true
      schema: { type: string }
      description: ID của bài viết.
    CommentId:
      name: comment_id
      in: path
      required: true
      schema: { type: string }
      description: ID của Comment.
    Limit:
      name: limit
      in: query
      schema: { type: integer, default: 20 }
      description: Số lượng bản ghi tối đa.
    Offset:
      name: offset
      in: query
      schema: { type: integer, default: 0 }
      description: Vị trí bắt đầu (bỏ qua X bản ghi).
    Cursor:
      name: cursor
      in: query
      schema: { type: string }
      description: ID của bản ghi cuối cùng đã lấy (cursor-based pagination).
    SortBy:
      name: sort_by
      in: query
      schema: { type: string, default: created_at }
      description: Trường sắp xếp.
    Order:
      name: order
      in: query
      schema: { type: string, enum: [asc, desc], default: desc }
      description: Chiều sắp xếp.

  # SCHEMAS (REQUEST/RESPONSE BODIES)
  schemas:
    # --- CHUNG (HATEOAS, RESPONSE) ---
    Link:
      type: object
      properties:
        href: { type: string, format: url, description: Đường dẫn tài nguyên. }
        method: { type: string, description: HTTP Method. }
    Links:
      type: object
      additionalProperties:
        $ref: '#/components/schemas/Link'
    Pagination:
      type: object
      properties:
        limit: { type: integer }
        offset: { type: integer }
        total_items: { type: integer, description: Tổng số bản ghi (khi không dùng cursor). }
    Metadata:
      type: object
      properties:
        pagination:
          $ref: '#/components/schemas/Pagination'

    # Cấu trúc Phản hồi Thành công Thống nhất
    SuccessResponse:
      type: object
      properties:
        status: { type: string, default: success }
        message: { type: string, description: Mô tả thành công. }
        data: { type: object, description: Dữ liệu trả về (tùy thuộc vào endpoint). }
        _links:
          $ref: '#/components/schemas/Links'
        metadata:
          $ref: '#/components/schemas/Metadata'
    
    # Cấu trúc Lỗi Chi tiết
    ErrorDetail:
      type: object
      properties:
        field: { type: string, description: Trường bị lỗi (validation). }
        message: { type: string, description: Mô tả lỗi chi tiết. }
    # Cấu trúc Phản hồi Lỗi Thống nhất
    ErrorResponse:
      type: object
      properties:
        status: { type: string, default: error }
        code: { type: string, description: Mã lỗi nội bộ (Ví dụ: RESOURCE_NOT_FOUND). }
        message: { type: string, description: Mô tả lỗi. }
        details:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'
            
    # --- POST SCHEMAS ---
    PostCreate: # POST /posts (multipart)
      type: object
      properties:
        content: { type: string, description: Nội dung text của bài viết (tùy chọn nếu có media). }
        tags: { type: string, description: JSON array string các hashtag gửi trong multipart (server sẽ parse). }
        post_share_id: { type: string, description: ID bài viết được chia sẻ. }
        group_id: { type: string, description: ID Group đăng bài. }
        visibility: { type: string, enum: [public, friends, private], default: public }
        files:
          type: array
          description: Danh sách file media upload.
          items:
            type: string
            format: binary

    PostUpdate: # PATCH /posts/{post_id} (multipart)
      type: object
      properties:
        content: { type: string, description: Nội dung mới (tùy chọn). }
        tags: { type: string, description: JSON array string mới. }
        visibility: { type: string, enum: [public, friends, private] }
        files:
          type: array
          description: Danh sách file media mới (xóa toàn bộ media cũ trước). Không gửi => xóa media.
          items:
            type: string
            format: binary

    PostObject: # Đối tượng bài viết được trả về
      type: object
      properties:
        post_id: { type: string }
        user_id: { type: string }
        content: { type: string, nullable: true }
        media_urls: { type: array, items: { type: string }, nullable: true }
        reacts_count: { type: integer }
        comments_count: { type: integer }
        tags: { type: array, items: { type: string }, nullable: true }
        visibility: { type: string, enum: [public, friends, private], nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    PostSingleResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - properties:
            data:
              $ref: '#/components/schemas/PostObject'
    PostListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/PostObject'

    # --- REACTION SCHEMAS ---
    ReactionUpsert: # POST /posts/{post_id}/reactions hoặc /comments/{comment_id}/reactions
      type: object
      required: [reaction_type]
      properties:
        reaction_type: { type: string, enum: [like, love, haha, wow, sad, angry] }

    ReactionObject:
      type: object
      properties:
        reaction_id: { type: string }
        user_id: { type: string }
        post_id: { type: string, nullable: true }
        comment_id: { type: string, nullable: true }
        reaction_type: { type: string }

    ReactionSingleResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - properties:
            data:
              $ref: '#/components/schemas/ReactionObject'
              
    ReactionListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/ReactionObject'

    # --- COMMENT SCHEMAS ---
    CommentCreate: # POST /posts/{post_id}/comments (multipart)
      type: object
      properties:
        content: { type: string, description: Nội dung comment (có thể rỗng nếu chỉ gửi media). }
        parent_id: { type: string, description: ID Comment cha nếu là Reply. }
        tags: { type: string, description: JSON array string các hashtag (multipart). }
        files:
          type: array
          items:
            type: string
            format: binary
          description: Danh sách file media upload.

    CommentUpdate: # PATCH /posts/{post_id}/comments/{comment_id} (multipart)
      type: object
      properties:
        content: { type: string, description: Nội dung mới (tùy chọn). }
        tags: { type: string, description: JSON array string mới. }
        files:
          type: array
          items:
            type: string
            format: binary
          description: Danh sách file media mới (xóa toàn bộ media cũ trước). Không gửi => xóa media.
        
    CommentObject:
      type: object
      properties:
        comment_id: { type: string }
        user_id: { type: string }
        post_id: { type: string }
        parent_id: { type: string, nullable: true }
        content: { type: string, nullable: true }
        media_urls: { type: array, items: { type: string }, nullable: true }
        reacts_count: { type: integer }
        replies_count: { type: integer }
        tags: { type: array, items: { type: string }, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        
    CommentSingleResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - properties:
            data:
              $ref: '#/components/schemas/CommentObject'
              
    CommentListResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/CommentObject'

    # CommentReactionUpsert removed: dùng chung ReactionUpsert với reaction_type
  
  # RESPONSES
  responses:
    NotFound:
      description: Không tìm thấy tài nguyên.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            code: RESOURCE_NOT_FOUND
            message: Tài nguyên được yêu cầu không tồn tại.
    BadRequest:
      description: Yêu cầu không hợp lệ (Validation Error).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            code: INVALID_INPUT
            message: Một hoặc nhiều trường đầu vào không hợp lệ.
            details:
              - field: content
                message: Nội dung không được để trống.
    Unauthorized:
      description: Không được phép (Thiếu/Sai JWT).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            code: AUTH_REQUIRED
            message: Yêu cầu xác thực.
    Forbidden:
      description: Bị từ chối (Không có quyền).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            code: PERMISSION_DENIED
            message: Người dùng không có quyền truy cập tài nguyên này.