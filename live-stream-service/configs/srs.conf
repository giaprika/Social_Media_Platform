# ===========================================
# SRS Configuration for Live Streaming Service
# Documentation: https://ossrs.io/lts/en-us/docs/v5/doc/getting-started
# ===========================================

listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;
srs_log_level       info;

# Heartbeat to detect server status
heartbeat {
    enabled         off;
}

# ===========================================
# HTTP API Server
# Used for server management and statistics
# ===========================================
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
    raw_api {
        enabled     off;
    }
}

# ===========================================
# HTTP Server for HLS delivery
# ===========================================
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
    crossdomain     on;
}

# ===========================================
# WebRTC Configuration
# ===========================================
rtc_server {
    enabled         on;
    listen          8000;
    candidate       $CANDIDATE;
}

# ===========================================
# Statistics
# ===========================================
stats {
    network         0;
}

# ===========================================
# Live Streaming Application
# ===========================================
vhost __defaultVhost__ {
    # -----------------------------------------
    # TCP Settings
    # -----------------------------------------
    tcp_nodelay     on;
    min_latency     on;

    # -----------------------------------------
    # Play Configuration
    # -----------------------------------------
    play {
        gop_cache       off;
        queue_length    10;
        mw_latency      100;
    }

    # -----------------------------------------
    # Publish Configuration
    # -----------------------------------------
    publish {
        mr              off;
        firstpkt_timeout    20000;
        normal_timeout      7000;
    }

    # -----------------------------------------
    # HLS Output Configuration
    # Optimized for gcsfuse (GCS mount) - network filesystem
    # -----------------------------------------
    hls {
        enabled         on;
        
        # 1. Output path - mounted gcsfuse directory
        # Docker volume: /mnt/live_data:/data
        hls_path        /data;
        
        # 2. Fragment & Window Settings
        # ⚠️ IMPORTANT: gcsfuse has network latency
        # - fragment 5s: Safe for gcsfuse, reduces I/O frequency
        # - fragment 2s: Aggressive, may cause I/O blocking (use after testing)
        # - window 60s: Keep 12 segments (5s x 12 = 60s buffer)
        hls_fragment    5;
        hls_window      60;
        
        # 3. File naming convention
        # Output: /data/live/{stream_key}.m3u8
        # Segments: /data/live/{stream_key}-0.ts, {stream_key}-1.ts, ...
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
        
        # 4. Cleanup settings
        # OFF: Let GCS lifecycle rules handle cleanup (recommended)
        # This prevents 404 errors when CDN caches old segment URLs
        hls_cleanup     off;
        
        # 5. Dispose timeout - remove m3u8 from memory after stream ends
        hls_dispose     30;
        
        # 6. Wait for keyframe before starting segment
        # Ensures clean segment boundaries for better playback
        hls_wait_keyframe   on;
        
        # 7. Additional optimizations for network filesystem
        # aof_ratio: Append-only file ratio (reduces rewrites)
        hls_aof_ratio   2.0;
    }

    # -----------------------------------------
    # WebRTC Configuration
    # -----------------------------------------
    rtc {
        enabled         on;
        rtmp_to_rtc     on;
        rtc_to_rtmp     on;
    }

    # -----------------------------------------
    # HTTP Hooks for Stream Authentication
    # CRITICAL: These callbacks validate stream keys
    # Return HTTP 200 to allow, non-200 to reject
    # -----------------------------------------
    http_hooks {
        enabled         on;
        
        # Called when client connects to server
        # on_connect      http://api:8080/api/v1/callbacks/on_connect;
        
        # Called when client starts publishing (CRITICAL)
        # Validates stream_key against database
        # Returns 200 = allow publish, 403 = reject
        on_publish      http://api:8080/api/v1/callbacks/on_publish;
        
        # Called when client stops publishing (CRITICAL)
        # Updates session status to ENDED
        on_unpublish    http://api:8080/api/v1/callbacks/on_unpublish;
        
        # Called when client starts playing
        # on_play         http://api:8080/api/v1/callbacks/on_play;
        
        # Called when client stops playing
        # on_stop         http://api:8080/api/v1/callbacks/on_stop;
        
        # Called when HLS segment is created
        # on_hls          http://api:8080/api/v1/callbacks/on_hls;
    }

    # -----------------------------------------
    # HTTP Remux for FLV streaming (optional)
    # -----------------------------------------
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
    }
}
