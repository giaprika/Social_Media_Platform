# ===========================================
# SRS Configuration for Live Streaming Service
# Documentation: https://ossrs.io/lts/en-us/docs/v5/doc/getting-started
# ===========================================

listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;
srs_log_level       info;

# Heartbeat to detect server status
heartbeat {
    enabled         off;
}

# ===========================================
# HTTP API Server
# Used for server management and statistics
# ===========================================
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
    raw_api {
        enabled     off;
    }
}

# ===========================================
# HTTP Server for HLS delivery
# ===========================================
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
    crossdomain     on;
}

# ===========================================
# WebRTC Configuration
# ===========================================
rtc_server {
    enabled         on;
    listen          8000;
    candidate       $CANDIDATE;
}

# ===========================================
# Statistics
# ===========================================
stats {
    network         0;
}

# ===========================================
# Live Streaming Application
# ===========================================
vhost __defaultVhost__ {
    # -----------------------------------------
    # TCP Settings
    # -----------------------------------------
    tcp_nodelay     on;
    min_latency     on;

    # -----------------------------------------
    # Play Configuration
    # -----------------------------------------
    play {
        gop_cache       off;
        queue_length    10;
        mw_latency      100;
    }

    # -----------------------------------------
    # Publish Configuration
    # -----------------------------------------
    publish {
        mr              off;
        firstpkt_timeout    20000;
        normal_timeout      7000;
    }

    # -----------------------------------------
    # HLS Output Configuration
    # -----------------------------------------
    hls {
        enabled         on;
        
        # 1. Đường dẫn tuyệt đối (Dễ map volume Docker)
        hls_path        /data; 
        
        # 2. Fragment & Window
        # Fragment 2s là rất aggressive với gcsfuse. 
        # Nếu thấy log báo lỗi write chậm, hãy tăng lên 4 hoặc 5.
        hls_fragment    2;
        hls_window      10;
        
        # 3. File naming
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
        
        # 4. QUAN TRỌNG: Tắt cleanup để tránh lỗi 404 với CDN
        hls_cleanup     off; 
        
        # Xóa file m3u8 khỏi RAM srs khi user tắt live
        hls_dispose     30;
        hls_wait_keyframe on;
    }

    # -----------------------------------------
    # WebRTC Configuration
    # -----------------------------------------
    rtc {
        enabled         on;
        rtmp_to_rtc     on;
        rtc_to_rtmp     on;
    }

    # -----------------------------------------
    # HTTP Hooks for Stream Authentication
    # CRITICAL: These callbacks validate stream keys
    # Return HTTP 200 to allow, non-200 to reject
    # -----------------------------------------
    http_hooks {
        enabled         on;
        
        # Called when client connects to server
        # on_connect      http://api:8080/api/v1/callbacks/on_connect;
        
        # Called when client starts publishing (CRITICAL)
        # Validates stream_key against database
        # Returns 200 = allow publish, 403 = reject
        on_publish      http://api:8080/api/v1/callbacks/on_publish;
        
        # Called when client stops publishing (CRITICAL)
        # Updates session status to ENDED
        on_unpublish    http://api:8080/api/v1/callbacks/on_unpublish;
        
        # Called when client starts playing
        # on_play         http://api:8080/api/v1/callbacks/on_play;
        
        # Called when client stops playing
        # on_stop         http://api:8080/api/v1/callbacks/on_stop;
        
        # Called when HLS segment is created
        # on_hls          http://api:8080/api/v1/callbacks/on_hls;
    }

    # -----------------------------------------
    # HTTP Remux for FLV streaming (optional)
    # -----------------------------------------
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
    }
}
